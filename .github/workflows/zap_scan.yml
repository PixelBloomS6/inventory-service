name: Debug and Scan

on:
  push:
    branches: [ main ]

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Start and Debug App
        run: |
          # Create a complete .env.docker with all services
          cat > .env.docker << EOF
          DATABASE_URL=postgresql://postgres:postgres@db:5432/inventory_db
          RABBITMQ_HOST=rabbitmq
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=inventory_db
          EOF
          
          echo "üöÄ Starting database first..."
          docker compose up -d db rabbitmq
          
          echo "‚è≥ Waiting for database to be ready..."
          for i in {1..30}; do
            if docker compose exec -T db pg_isready -U postgres 2>/dev/null; then
              echo "‚úÖ Database is ready!"
              break
            fi
            echo "Waiting for database... ($i/30)"
            sleep 2
          done
          
          echo "üöÄ Now starting the app..."
          docker compose up -d --build app
          
          echo "‚è≥ Waiting for app to start..."
          sleep 30
          
          echo "üìä Container status:"
          docker compose ps
          
          echo "üìã Full logs:"
          docker compose logs
          
          echo "üîç What's listening on ports:"
          docker compose exec -T app netstat -tlnp 2>/dev/null || echo "netstat failed"
          
          echo "üåê Port mapping check:"
          docker port $(docker compose ps -q app) 2>/dev/null || echo "No port mapping found"
          
          echo "üîå Testing connectivity:"
          for port in 8000 8001 3000 5000 80; do
            echo "Testing port $port..."
            curl -I http://localhost:$port 2>/dev/null && echo "‚úÖ Port $port works!" || echo "‚ùå Port $port failed"
          done
          
          echo "üê≥ Container inspect:"
          docker compose exec -T app ps aux 2>/dev/null || echo "ps failed"

      - name: Run ZAP (only if app responds)
        run: |
          # Find which port actually works
          APP_PORT=""
          for port in 8000 8001 3000 5000 80; do
            if curl -f http://localhost:$port 2>/dev/null; then
              APP_PORT=$port
              echo "‚úÖ Found working port: $port"
              break
            fi
          done
          
          if [ -n "$APP_PORT" ]; then
            echo "üîç Running ZAP scan on port $APP_PORT"
            docker run --rm --network host \
              -v $(pwd):/zap/wrk/:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-baseline.py \
                -t http://localhost:$APP_PORT \
                -J zap-report.json \
                -I || echo "ZAP completed with warnings"
          else
            echo "‚ùå No working port found - skipping ZAP scan"
            echo "Check the logs above to see why your app isn't starting"
            exit 1
          fi

      - name: Upload Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: zap-report.json

      - name: Cleanup
        if: always()
        run: docker compose down